<?php
/**
 * NeutromeLabs AiLand PHTML Form Template
 *
 * @var Template $block
 */

// You can add necessary block dependencies via layout XML if needed later
// For example, to get form URLs, config values etc.
use Magento\Backend\Block\Template;
use NeutromeLabs\AiLand\Block\Adminhtml\Form\Field\StoreSelector;

$generateUrl = $block->getUrl('ailand/landing/generate'); // URL for AJAX generation
$saveUrl = $block->getUrl('ailand/landing/save');       // URL for form submission

// Get prompt templates data from the child block added in layout
/** @var \NeutromeLabs\AiLand\Block\Adminhtml\Landing\PromptTemplates $promptTemplatesBlock */
$promptTemplatesBlock = $block->getChildBlock('prompt_templates');
$promptTemplatesJson = $promptTemplatesBlock ? $promptTemplatesBlock->getPromptTemplatesJson() : '{}';

?>
<div class="ailand-form-container">
    <form id="ailand_landing_form" action="<?= $block->escapeUrl($saveUrl) ?>" method="post" target="_blank"> <!-- Added target="_blank" -->
        <?= $block->getBlockHtml('formkey') ?> <!-- Add form key for security -->

        <!-- Buttons at the top -->
        <div class="page-actions"> <!-- Added margin-top -->
            <div class="page-actions-buttons" style="float: unset; margin-bottom: 50px;">
                <?= $block->getChildHtml('generate_button') ?>
                <?= $block->getChildHtml('improve_button') ?>
                <?= $block->getChildHtml('save_button') ?>
            </div>
        </div>

        <!-- Output Settings Group -->
        <div class="admin__fieldset">
            <legend class="admin__legend"><span><?= $block->escapeHtml(__('Output Settings')) ?></span></legend>
            <br>

            <div class="admin__field _required">
                <label class="admin__field-label" for="save_as_type"><span><?= $block->escapeHtml(__('Save As (CMS Entity Type)')) ?></span></label>
                <div class="admin__field-control">
                    <select id="save_as_type" name="save_as_type" class="admin__control-select" data-validate="{required:true}">
                        <option value=""><?= $block->escapeHtml(__('-- Please Select --')) ?></option>
                        <option value="page"><?= $block->escapeHtml(__('CMS Page')) ?></option>
                        <option value="block" selected><?= $block->escapeHtml(__('CMS Block')) ?></option> <!-- Set Block as default -->
                    </select>
                    <div class="admin__field-note">
                        <span><?= $block->escapeHtml(__('Select whether to save the result as a CMS Page or a CMS Block.')) ?></span>
                    </div>
                </div>
            </div>

            <div class="admin__field _required">
                <label class="admin__field-label"
                       for="title"><span><?= $block->escapeHtml(__('Title')) ?></span></label>
                <div class="admin__field-control">
                    <input id="title" name="title" type="text" class="admin__control-text" value=""
                           data-validate="{required:true}"/>
                </div>
            </div>

            <div class="admin__field _required">
                <label class="admin__field-label"
                       for="identifier"><span><?= $block->escapeHtml(__('Identifier')) ?></span></label>
                <div class="admin__field-control">
                    <input id="identifier" name="identifier" type="text" class="admin__control-text" value=""
                           data-validate="{required:true, 'validate-identifier':true}"/>
                    <div class="admin__field-note">
                        <span><?= $block->escapeHtml(__('Use lowercase letters, numbers, and underscores. Example: my_ai_landing_page')) ?></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Context Group -->
        <div class="admin__fieldset">
            <legend class="admin__legend"><span><?= $block->escapeHtml(__('Context')) ?></span></legend>
            <br>

            <!-- Custom Store Selector Field -->
            <div class="admin__field _required"> <!-- Making it required as generator needs it -->
                <label class="admin__field-label"
                       for="store_id"><span><?= $block->escapeHtml(__('Store View')) ?></span></label>
                <div class="admin__field-control">
                    <?php
                    // Instantiate and render the custom block directly
                    $storeSelectorBlock = $block->getLayout()->createBlock(StoreSelector::class);
                    echo $storeSelectorBlock
                        ->setName('store_id') // Set the name attribute for form submission
                        ->setId('store_id')   // Set the ID attribute for JS targeting
                        ->setClass('admin__control-select') // Standard Magento select class
                        ->toHtml();
                    ?>
                    <div class="admin__field-note">
                        <span><?= $block->escapeHtml(__('Select the Store View context for generation.')) ?></span>
                    </div>
                </div>
            </div>

            <div class="admin__field">
                <label class="admin__field-label"
                       for="styling_reference_url"><span><?= $block->escapeHtml(__('Reference Styling URL')) ?></span></label>
                <div class="admin__field-control">
                    <input id="styling_reference_url" name="styling_reference_url" type="url" class="admin__control-text"
                           value=""/>
                    <div class="admin__field-note">
                        <span><?= $block->escapeHtml(__('(Optional) Provide a URL whose HTML structure and style will be used as a reference. Defaults to the selected Store View\'s base URL.')) ?></span>
                    </div>
                </div>
            </div>

            <div class="admin__field">
                <label class="admin__field-label"
                       for="reference_image_url"><span><?= $block->escapeHtml(__('Reference Image URL')) ?></span></label>
                <div class="admin__field-control">
                    <input id="reference_image_url" name="reference_image_url" type="url" class="admin__control-text"
                           value=""/>
                     <div class="admin__field-note">
                        <span><?= $block->escapeHtml(__('(Optional) Provide a URL to an image for visual reference.')) ?></span>
                    </div>
                </div>
            </div>

            <div class="admin__field">
                <label class="admin__field-label"
                       for="generate_interactive"><span><?= $block->escapeHtml(__('Interactive with GraphQL')) ?></span></label>
                <div class="admin__field-control">
                    <input id="generate_interactive" name="generate_interactive" type="checkbox"
                           class="admin__control-checkbox" value="1"/>
                    <label class="admin__field-label" for="generate_interactive" style="margin-left: 5px;"><span><?= $block->escapeHtml(__('Enable')) ?></span></label> <!-- Simplified label -->
                    <div class="admin__field-note">
                        <span><?= $block->escapeHtml(__('If checked, the AI will be instructed to use Magento GraphQL for dynamic data and actions (e.g., product loading, add to cart). If unchecked, the AI will generate static content based on the prompt and context.')) ?></span>
                    </div>
                </div>
            </div>

             <div class="admin__field">
                <label class="admin__field-label"
                       for="data_source_type"><span><?= $block->escapeHtml(__('Data Source')) ?></span></label>
                <div class="admin__field-control">
                    <select id="data_source_type" name="data_source_type" class="admin__control-select">
                        <option value=""><?= $block->escapeHtml(__('-- None --')) ?></option>
                        <option value="product"><?= $block->escapeHtml(__('Product')) ?></option>
                        <option value="category"><?= $block->escapeHtml(__('Category')) ?></option>
                    </select>
                    <div class="admin__field-note">
                        <span><?= $block->escapeHtml(__('Optionally select a Product or Category to provide additional context data to the AI along with your prompt.')) ?></span>
                    </div>
                </div>
            </div>

            <div class="admin__field" id="product_id_field" style="display: none;"> <!-- Initially hidden -->
                <label class="admin__field-label"
                       for="product_id"><span><?= $block->escapeHtml(__('Product/Category ID')) ?></span></label>
                <div class="admin__field-control">
                    <input id="product_id" name="product_id" type="text" class="admin__control-text" value=""/>
                    <div class="admin__field-note">
                        <span><?= $block->escapeHtml(__('Enter Product ID manually.')) ?></span>
                    </div>
                </div>
            </div>

            <div class="admin__field" id="category_id_field" style="display: none;"> <!-- Initially hidden -->
                <label class="admin__field-label"
                       for="category_id"><span><?= $block->escapeHtml(__('Product/Category ID')) ?></span></label>
                <div class="admin__field-control">
                    <input id="category_id" name="category_id" type="text" class="admin__control-text" value=""/>
                    <div class="admin__field-note">
                        <span><?= $block->escapeHtml(__('Enter Category ID manually.')) ?></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Prompt Group -->
        <div class="admin__fieldset">
            <legend class="admin__legend"><span><?= $block->escapeHtml(__('Prompt')) ?></span></legend>
            <br>

            <div class="admin__field">
                <label class="admin__field-label" for="predefined_prompt_selector"><span><?= $block->escapeHtml(__('Load Template')) ?></span></label>
                <div class="admin__field-control">
                    <select id="predefined_prompt_selector" name="predefined_prompt_selector" class="admin__control-select">
                        <option value=""><?= $block->escapeHtml(__('-- Select a template to load --')) ?></option>
                        <!-- Options will be populated by JS -->
                    </select>
                     <div class="admin__field-note">
                        <span><?= $block->escapeHtml(__('Selecting a template will replace the content of the Prompt field below.')) ?></span>
                    </div>
               </div>
            </div>

            <div class="admin__field _required"> <!-- Making prompt required now -->
                <label class="admin__field-label"
                       for="custom_prompt"><span><?= $block->escapeHtml(__('Prompt')) ?></span></label>
                <div class="admin__field-control">
                    <textarea id="custom_prompt" name="custom_prompt" class="admin__control-textarea"
                              rows="15" data-validate="{required:true}"></textarea> <!-- Increased rows and made required -->
                    <div class="admin__field-note">
                        <span><?= $block->escapeHtml(__('Enter the detailed prompt for the AI. Use the template loader above or write your own.')) ?></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Generation Results -->
        <div class="admin__fieldset">
            <legend class="admin__legend"><span><?= $block->escapeHtml(__('AI Generation Results')) ?></span></legend>
            <br>

            <div class="admin__field">
                <label class="admin__field-label"
                       for="generated_design_plan"><span><?= $block->escapeHtml(__('Generated Design Plan (Stage 1)')) ?></span></label>
                <div class="admin__field-control">
                    <textarea id="generated_design_plan" name="generated_design_plan" class="admin__control-textarea"
                              rows="8" readonly="readonly"></textarea>
                    <div class="admin__field-note">
                        <span><?= $block->escapeHtml(__('The technical design plan generated by the AI. This is used as input for Stage 2.')) ?></span>
                    </div>
                </div>
            </div>

            <div class="admin__field">
                <label class="admin__field-label"
                       for="generated_content_preview"><span><?= $block->escapeHtml(__('Generated HTML Preview (Stage 2)')) ?></span></label>
                <div class="admin__field-control">
                    <!-- Iframe for rendering preview -->
                    <iframe id="generated_content_preview"
                            style="width: 100%; height: 800px; zoom: 0.7; resize: both; overflow: auto; border: 1px solid #ccc;"></iframe>
                    <!-- Hidden textarea to hold the content for form submission -->
                    <textarea id="generated_content" name="generated_content" style="display: none;"></textarea>
                    <div class="admin__field-note">
                        <span><?= $block->escapeHtml(__('The AI-generated HTML content will be rendered above. Review before saving.')) ?></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Buttons at the bottom -->
        <div class="page-actions">
            <div class="page-actions-buttons">
                <?= $block->getChildHtml('generate_button') ?>
                <?= $block->getChildHtml('improve_button') ?>
                <?= $block->getChildHtml('save_button') ?>
            </div>
        </div>
    </form>
</div>

<script type="text/x-magento-init">
    {
        "*": {
            "NeutromeLabs_AiLand/js/form-interactions": {
                "generateUrl": "<?= $block->escapeJs($block->escapeUrl($generateUrl)) ?>",
                "saveAsTypeSelector": "#save_as_type",
                "promptTemplateSelector": "#predefined_prompt_selector",
                "customPromptSelector": "#custom_prompt",
                "promptTemplatesJson": <?= /* @noEscape */ $promptTemplatesJson ?>,
                "dataSourceTypeSelector": "#data_source_type",
                "productIdFieldContainer": "#product_id_field",
                "categoryIdFieldContainer": "#category_id_field",
                "titleLabelSelector": "label[for='title'] span",
                "identifierLabelSelector": "label[for='identifier'] span",
                "generateButtonClass": ".generate-ai-content-button",
                "improveButtonClass": ".improve-ai-content-button",
                "designPlanArea": "#generated_design_plan",
                "previewArea": "#generated_content",
                "previewIframe": "#generated_content_preview",
                "formId": "#ailand_landing_form",
                "storeSwitcherSelector": "#store_id"
            }
        }
    }
</script>
